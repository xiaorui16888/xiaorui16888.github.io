<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>logstash之mysql全量及增量同步数据到ElasticSearch | Guo&#39;s Log</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="https://github.githubassets.com/favicon.ico">
    <meta name="description" content="Guo&#39;s Log">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.28dec583.js" as="script"><link rel="preload" href="/assets/js/2.6390456d.js" as="script"><link rel="preload" href="/assets/js/16.da318227.js" as="script"><link rel="prefetch" href="/assets/js/10.3c798194.js"><link rel="prefetch" href="/assets/js/11.cb42a660.js"><link rel="prefetch" href="/assets/js/12.7500de30.js"><link rel="prefetch" href="/assets/js/13.a712f3c5.js"><link rel="prefetch" href="/assets/js/14.4b2bf3ab.js"><link rel="prefetch" href="/assets/js/15.fbc475b6.js"><link rel="prefetch" href="/assets/js/17.2ebca9f8.js"><link rel="prefetch" href="/assets/js/18.0f459eef.js"><link rel="prefetch" href="/assets/js/19.7d7944c9.js"><link rel="prefetch" href="/assets/js/20.452260e7.js"><link rel="prefetch" href="/assets/js/21.e3753087.js"><link rel="prefetch" href="/assets/js/22.c3d2246d.js"><link rel="prefetch" href="/assets/js/23.7ee4bb17.js"><link rel="prefetch" href="/assets/js/24.752de632.js"><link rel="prefetch" href="/assets/js/25.ca140f42.js"><link rel="prefetch" href="/assets/js/26.61179b09.js"><link rel="prefetch" href="/assets/js/27.51f5a172.js"><link rel="prefetch" href="/assets/js/28.066d630b.js"><link rel="prefetch" href="/assets/js/29.741f5e6a.js"><link rel="prefetch" href="/assets/js/3.2abf0e80.js"><link rel="prefetch" href="/assets/js/30.7b62c404.js"><link rel="prefetch" href="/assets/js/31.79300469.js"><link rel="prefetch" href="/assets/js/32.ac2a3170.js"><link rel="prefetch" href="/assets/js/33.add23a97.js"><link rel="prefetch" href="/assets/js/34.cd85f68d.js"><link rel="prefetch" href="/assets/js/35.799daa04.js"><link rel="prefetch" href="/assets/js/36.ec6df235.js"><link rel="prefetch" href="/assets/js/37.07ce225c.js"><link rel="prefetch" href="/assets/js/38.412e3496.js"><link rel="prefetch" href="/assets/js/39.36612e17.js"><link rel="prefetch" href="/assets/js/4.c00350ea.js"><link rel="prefetch" href="/assets/js/40.34a68ca2.js"><link rel="prefetch" href="/assets/js/41.430eb2f1.js"><link rel="prefetch" href="/assets/js/42.b9ff7191.js"><link rel="prefetch" href="/assets/js/43.2424609e.js"><link rel="prefetch" href="/assets/js/44.01dc18b6.js"><link rel="prefetch" href="/assets/js/45.03b59b8d.js"><link rel="prefetch" href="/assets/js/46.1e19f6b1.js"><link rel="prefetch" href="/assets/js/47.1cbe76fa.js"><link rel="prefetch" href="/assets/js/48.d5e6949d.js"><link rel="prefetch" href="/assets/js/49.8ac37556.js"><link rel="prefetch" href="/assets/js/5.4f989433.js"><link rel="prefetch" href="/assets/js/50.0c5ed7df.js"><link rel="prefetch" href="/assets/js/51.d1eb99a9.js"><link rel="prefetch" href="/assets/js/52.6c9459d9.js"><link rel="prefetch" href="/assets/js/53.cc57295c.js"><link rel="prefetch" href="/assets/js/54.9a8d1f5f.js"><link rel="prefetch" href="/assets/js/55.6aa8f49f.js"><link rel="prefetch" href="/assets/js/56.2b173875.js"><link rel="prefetch" href="/assets/js/57.36538ea4.js"><link rel="prefetch" href="/assets/js/58.17065c17.js"><link rel="prefetch" href="/assets/js/59.d9634f62.js"><link rel="prefetch" href="/assets/js/6.1289db6c.js"><link rel="prefetch" href="/assets/js/60.b7684427.js"><link rel="prefetch" href="/assets/js/61.79615f83.js"><link rel="prefetch" href="/assets/js/62.96aa6740.js"><link rel="prefetch" href="/assets/js/63.634ed976.js"><link rel="prefetch" href="/assets/js/64.b02a515c.js"><link rel="prefetch" href="/assets/js/65.202b9ad2.js"><link rel="prefetch" href="/assets/js/66.cfdecfcb.js"><link rel="prefetch" href="/assets/js/67.5b07c79f.js"><link rel="prefetch" href="/assets/js/7.ef389b56.js"><link rel="prefetch" href="/assets/js/8.2504a519.js"><link rel="prefetch" href="/assets/js/9.76555228.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Guo's Log</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Notes/" class="nav-link router-link-active">
  笔记
</a></div> <a href="https://github.com/xiaorui16888" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Notes/" class="nav-link router-link-active">
  笔记
</a></div> <a href="https://github.com/xiaorui16888" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>AppScheme协议相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CDN</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Django</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ELK相关</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Notes/ELK相关/ElasticSearch+Kibana设置用户名密码登陆.html" class="sidebar-link">ElasticSearch+Kibana设置用户名密码登陆</a></li><li><a href="/Notes/ELK相关/Linux下安装部署ElasticSearch、kibana、logstash.html" class="sidebar-link">Linux下安装部署ElasticSearch</a></li><li><a href="/Notes/ELK相关/ThinkPHP3项目构建与ES的使用.html" class="sidebar-link">ThinkPHP3项目构建与ES的使用</a></li><li><a href="/Notes/ELK相关/logstash之mysql全量及增量同步数据到ElasticSearch.html" class="active sidebar-link">logstash之mysql全量及增量同步数据到ElasticSearch</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Notes/ELK相关/logstash之mysql全量及增量同步数据到ElasticSearch.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/Notes/ELK相关/logstash之mysql全量及增量同步数据到ElasticSearch.html#准备工作" class="sidebar-link">准备工作</a></li><li class="sidebar-sub-header"><a href="/Notes/ELK相关/logstash之mysql全量及增量同步数据到ElasticSearch.html#其他" class="sidebar-link">其他</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Github</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Linux相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>PHP开发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python+selenium</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Python配置相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>SEO技巧</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Websocket通讯</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>mysql相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端疑难杂症</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>好用工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>宝塔相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微信开发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>微信机器人开发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数字货币</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>科学上网</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>营销工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>虚拟机相关</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>软件测试</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>软件破解</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>防御技巧</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="logstash之mysql全量及增量同步数据到elasticsearch"><a href="#logstash之mysql全量及增量同步数据到elasticsearch" class="header-anchor">#</a> logstash之mysql全量及增量同步数据到ElasticSearch</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>我一般数据都是存在mysql的，但是mysql的全文检索性能，大家也都知道。数据量小还没啥事，一旦数据量上了几百万，几千万，分分钟给你卡死...</p> <p>所以我都是把需要检索用到的数据，同步到es中。但是怎么同步呢？我之前提到过<code>logstash</code>。有人说，把mysql中的数据导出成csv同步到es，或者就excel直接扔到es中。这种方法我也去实践了一遍，结果经常有一些数据中含有特殊的一些字符，同步失败，而导致很多数据都没有成功同步上去。</p> <p>那算了，这种方法我们就弃用了！</p> <p><code>logstash</code>其实给我们提供了，mysql数据同步到es中。无需我们初始化一个demo，写一大堆代码，同步到es中。</p> <p>说干就干！</p> <h2 id="准备工作"><a href="#准备工作" class="header-anchor">#</a> 准备工作</h2> <p>es与logstash的版本保持一致，</p> <p>下载jdbc-connector的jar包，<code>mysql-connector-java.jar</code></p> <p><em>maven仓库下载</em>：https://mvnrepository.com/artifact/mysql/mysql-connector-java</p> <p>下载完成后，解压到logstash/lib/jars/中。</p> <h3 id="配置导入脚本"><a href="#配置导入脚本" class="header-anchor">#</a> 配置导入脚本</h3> <p>新建配置目录：sync-config，新建<code>jdbc.conf</code></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code>input <span class="token punctuation">{</span>
    stdin <span class="token punctuation">{</span><span class="token punctuation">}</span>
    jdbc <span class="token punctuation">{</span>
   		<span class="token comment"># mysql 数据库链接</span>
        jdbc_connection_string =<span class="token punctuation">&gt;</span> &quot;jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/cicada<span class="token punctuation">?</span>characterEncoding=utf8&quot;
        <span class="token comment"># 用户名和密码</span>
        jdbc_user =<span class="token punctuation">&gt;</span> &quot;root&quot;
        jdbc_password =<span class="token punctuation">&gt;</span> &quot;root123&quot;
        <span class="token comment"># 驱动</span>
        jdbc_driver_library =<span class="token punctuation">&gt;</span> &quot;./lib/jars/mysql<span class="token punctuation">-</span>connector<span class="token punctuation">-</span>java<span class="token punctuation">-</span>5.1.13.jar&quot;
        <span class="token comment"># 驱动类名</span>
        jdbc_driver_class =<span class="token punctuation">&gt;</span> &quot;com.mysql.jdbc.Driver&quot;
        jdbc_paging_enabled =<span class="token punctuation">&gt;</span> &quot;true&quot;
        jdbc_page_size =<span class="token punctuation">&gt;</span> &quot;50000&quot;
        <span class="token comment"># 时区</span>
        jdbc_default_timezone =<span class="token punctuation">&gt;</span> &quot;Asia/Shanghai&quot;
        <span class="token comment"># 执行的sql文件路径和名称</span>
        statement_filepath =<span class="token punctuation">&gt;</span> &quot;./sync<span class="token punctuation">-</span>config/user_sql.sql&quot;
        <span class="token comment">#直接执行sql语句</span>
      	<span class="token comment"># statement =&gt;&quot;select * from employee&quot;</span>
        <span class="token comment"># 设置监听间隔，各字段含义（由左至右）分、时、天、月、年，全部为*默认含义为每分钟都更新</span>
        schedule =<span class="token punctuation">&gt;</span> &quot;* * * * <span class="token important">*&quot;</span>
        <span class="token comment"># 索引类型</span>
        type =<span class="token punctuation">&gt;</span> &quot;User&quot;
        lowercase_column_names =<span class="token punctuation">&gt;</span> false
        <span class="token comment"># 是否记录最后一次运行内容</span>
        record_last_run =<span class="token punctuation">&gt;</span> true
        <span class="token comment"># 是否适用列元素</span>
        use_column_value =<span class="token punctuation">&gt;</span> true
        <span class="token comment"># 追踪的元素名，对应保存到es上面的字段名而不是数据库字段名</span>
        tracking_column =<span class="token punctuation">&gt;</span> &quot;updateTime&quot;
        <span class="token comment"># 默认为number，如果为日期必须声明为timestamp</span>
        tracking_column_type =<span class="token punctuation">&gt;</span> &quot;timestamp&quot;
        <span class="token comment"># 设置记录的路径</span>
        last_run_metadata_path =<span class="token punctuation">&gt;</span> &quot;./sync<span class="token punctuation">-</span>config/user_last_time&quot;
        clean_run =<span class="token punctuation">&gt;</span> false
    <span class="token punctuation">}</span>
    jdbc <span class="token punctuation">{</span>
        jdbc_connection_string =<span class="token punctuation">&gt;</span> &quot;jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>3306/cicada<span class="token punctuation">?</span>characterEncoding=utf8&quot;
        jdbc_user =<span class="token punctuation">&gt;</span> &quot;root&quot;
        jdbc_password =<span class="token punctuation">&gt;</span> &quot;root123&quot;
        jdbc_driver_library =<span class="token punctuation">&gt;</span> &quot;./lib/jars/mysql<span class="token punctuation">-</span>connector<span class="token punctuation">-</span>java<span class="token punctuation">-</span>5.1.13.jar&quot;
        jdbc_driver_class =<span class="token punctuation">&gt;</span> &quot;com.mysql.jdbc.Driver&quot;
        jdbc_paging_enabled =<span class="token punctuation">&gt;</span> &quot;true&quot;
        jdbc_page_size =<span class="token punctuation">&gt;</span> &quot;50000&quot;
        jdbc_default_timezone =<span class="token punctuation">&gt;</span> &quot;Asia/Shanghai&quot;
        statement_filepath =<span class="token punctuation">&gt;</span> &quot;./sync<span class="token punctuation">-</span>config/log_sql.sql&quot;
        schedule =<span class="token punctuation">&gt;</span> &quot;* * * * <span class="token important">*&quot;</span>
        type =<span class="token punctuation">&gt;</span> &quot;Log&quot;
        lowercase_column_names =<span class="token punctuation">&gt;</span> false
        record_last_run =<span class="token punctuation">&gt;</span> true
        use_column_value =<span class="token punctuation">&gt;</span> true
        tracking_column =<span class="token punctuation">&gt;</span> &quot;updateTime&quot;
        tracking_column_type =<span class="token punctuation">&gt;</span> &quot;timestamp&quot;
        last_run_metadata_path =<span class="token punctuation">&gt;</span> &quot;./sync<span class="token punctuation">-</span>config/log_last_time&quot;
        clean_run =<span class="token punctuation">&gt;</span> false
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
filter <span class="token punctuation">{</span>
    json <span class="token punctuation">{</span>
        source =<span class="token punctuation">&gt;</span> &quot;message&quot;
        remove_field =<span class="token punctuation">&gt;</span> <span class="token punctuation">[</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
output <span class="token punctuation">{</span>
    if <span class="token punctuation">[</span>type<span class="token punctuation">]</span> == &quot;User&quot; <span class="token punctuation">{</span>
        elasticsearch <span class="token punctuation">{</span>
            hosts =<span class="token punctuation">&gt;</span> <span class="token punctuation">[</span><span class="token string">&quot;127.0.0.1:9200&quot;</span><span class="token punctuation">]</span>
            <span class="token comment"># 索引名称</span>
            index =<span class="token punctuation">&gt;</span> &quot;cicada_user_search&quot;
            <span class="token comment"># type名称</span>
            document_type =<span class="token punctuation">&gt;</span> &quot;user_search_index&quot;
             <span class="token comment"># 文档id，inquiryId为sql文件中查询出的字段名</span>
            document_id =<span class="token punctuation">&gt;</span> &quot;%<span class="token punctuation">{</span>id<span class="token punctuation">}</span>&quot;
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    if <span class="token punctuation">[</span>type<span class="token punctuation">]</span> == &quot;Log&quot; <span class="token punctuation">{</span>
        elasticsearch <span class="token punctuation">{</span>
            hosts =<span class="token punctuation">&gt;</span> <span class="token punctuation">[</span><span class="token string">&quot;127.0.0.1:9200&quot;</span><span class="token punctuation">]</span>
            index =<span class="token punctuation">&gt;</span> &quot;cicada_log_search&quot;
            document_type =<span class="token punctuation">&gt;</span> &quot;log_search_index&quot;
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><h3 id="sql文件"><a href="#sql文件" class="header-anchor">#</a> SQL文件</h3> <ul><li><p>user_sql.sql</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
	id<span class="token punctuation">,</span>
	user_name userName<span class="token punctuation">,</span>
	user_phone userPhone<span class="token punctuation">,</span>
	create_time createTime<span class="token punctuation">,</span>
	update_time updateTime
<span class="token keyword">FROM</span> c_user
<span class="token keyword">WHERE</span> update_time <span class="token operator">&gt;</span> :sql_last_value
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>log_sql.sql</p> <div class="language-mysql line-numbers-mode"><pre class="language-text"><code>SELECT
	id,
	param_value paramValue,
	request_ip requestIp,
	create_time createTime,
	update_time updateTime
FROM c_log
WHERE update_time &gt; :sql_last_value
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li></ul> <h3 id="配置参数说明"><a href="#配置参数说明" class="header-anchor">#</a> 配置参数说明</h3> <ul><li><p>input参数</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code>statement_filepath：读取SQL语句位置
schedule ：这里配置每分钟执行一次
type ：类型，写入ES的标识
lowercase_column_names ：字段是否转小写
record_last_run ：记录上次执行时间
use_column_value ：使用列的值
tracking_column ：根据写入ES的updateTime字段区分增量数据
tracking_column_type ：区分的字段类型
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li> <li><p>output参数</p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code>hosts ：ES服务地址
index ：Index名称，类比理解数据库名称
document_type ：Type名称，类比理解表名称
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul> <h3 id="启动导入脚本"><a href="#启动导入脚本" class="header-anchor">#</a> 启动导入脚本</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>logstash -f <span class="token string">&quot;./sync-config/jdbc.conf&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h2> <h3 id="logstash7-x同步mysql数据到es报错"><a href="#logstash7-x同步mysql数据到es报错" class="header-anchor">#</a> logstash7.x同步mysql数据到es报错</h3> <p>logstash能正常启动但是同步数据到es时报错</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>com.mysql.jdbc.Driver not loaded. Are you sure you’ve included the correct jdbc driver in :jdbc_driver_library?
Unable to find driver class via URLClassLoader in given driver jars: com.mysql.jdbc.Driver and com.mysql.jdbc.Driver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>解决办法</strong>：将mysql的驱动jar包拷贝到logstash目录\logstash-core\lib\jars 下</p> <p>如果这种办法没有解决你的问题，你可以看看这篇帖子，我没试过，因为上面这种方法解决了我的问题。</p> <p>https://www.jianshu.com/p/0e893f29ee05</p> <p><em>LogStash 7.x com.mysql.cj.jdbc.Driver not loaded</em></p> <h3 id="mysql资源下载"><a href="#mysql资源下载" class="header-anchor">#</a> MYSQL资源下载</h3> <p>https://downloads.mysql.com/archives/</p> <h3 id="logstash-配置定时"><a href="#logstash-配置定时" class="header-anchor">#</a> Logstash 配置定时</h3> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token comment"># 设置监听时段 个字段含义(从左到右)，分,时,天,月,年, </span>
<span class="token comment"># 全部默认为*号默认为每分钟更新</span>
<span class="token comment">#每分钟执行一次</span>
schedule =<span class="token punctuation">&gt;</span> &quot;* * * * * &quot;
<span class="token comment"># 每间隔一分钟执行一次</span>
schedule =<span class="token punctuation">&gt;</span> &quot;<span class="token important">*/1</span> * * * <span class="token important">*&quot;</span>
<span class="token comment">#每小时执行一次</span>
schedule =<span class="token punctuation">&gt;</span>&quot;* <span class="token important">*/1</span> * * <span class="token important">*&quot;</span>
<span class="token comment">#某个时间点执行</span>
schedule =<span class="token punctuation">&gt;</span>&quot;* 1 * * <span class="token important">*&quot;</span>    <span class="token comment"># 每天上午1点执行</span>
<span class="token comment">#多个时间点执行</span>
schedule =<span class="token punctuation">&gt;</span>&quot;* 1<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>5 * * <span class="token important">*&quot;</span>    <span class="token comment"># 每天上午1,3,5点执行</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="es-mysql-logstash-软删除的实现"><a href="#es-mysql-logstash-软删除的实现" class="header-anchor">#</a> es-mysql-logstash 软删除的实现</h3> <p>如果一个文档从 MySQL 中删除，该操作并不会同步到 ElasticSearch 中。列举几个我们可以考虑的方案。</p> <p>MySQL 中的记录可通过包含 is_deleted 字段以表明该条记录是否有效。一旦发生更新，is_deleted 也会同步更新到 ElasticSearch 中。如果通过这种方式，在执行 MySQL 或 ElasticSearch 查询时，重写查询语句来过滤掉 is_deleted 为 true 的记录。同时，可以通过一些后台进程将 MySQL 和 ElasticSearch 中的这些文档删除。</p> <p>另一个可选方案是，应用系统负责 MySQL 和 ElasticSearch 中数据的删除，即应用系统在删除 MySQL 中数据，同时负责也删除 ElasticSearch 中相应的文档。这个就会到程序层面的开发工作。</p> <p>再谈一种方案，脱离 logstash 来谈这个问题。</p> <p>可以通过 mysql 的 binlog 实现数据库中的得事件(增加、更新、删除)同步，任何事件实时同步到 Elasticsearch。这个相对较复杂了。但好在已经有了开源组件可以用，即阿里的 canal。不过，我个人认为，项目不大，且实时性要求不高，还是用 logstash 比较简单省心。canal 在单表时，还比较简单，如果涉及多表，也不方便，根据需求会有不定量的的开发工作。</p> <p>最后，要依据场景选择合适的方案。把它们进行适时地结合，实时性要求高，用 canal 实现，一般场景，logstash 即可，即使是有题主提的删除，也不建议使用 canal，而是用前面提到的几个思路。有能力的话，其实可以针对这两种方案设计一个数据同步框架，以后只要加个配置即可完成。</p> <p><strong>这里的方案，是我在网上看到的，最近不着急实现这个功能，有空了再实现一下。</strong></p> <h3 id="联表的sql文件"><a href="#联表的sql文件" class="header-anchor">#</a> 联表的sql文件</h3> <div class="language-mysql line-numbers-mode"><pre class="language-text"><code>SELECT `a`.`id`,`a`.`catid`,`a`.`catids`,`a`.`title`,`f`.`name`, `a`.`status`,a.updated_at FROM `c_product` `a` LEFT JOIN `c_company` `f` ON f.id = a.cid WHERE a.updated_at &gt; :sql_last_value order by a.updated_at
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/xiaorui16888/edit/master/docs/Notes/ELK相关/logstash之mysql全量及增量同步数据到ElasticSearch.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/6/2022, 1:36:29 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Notes/ELK相关/ThinkPHP3项目构建与ES的使用.html" class="prev">
        ThinkPHP3项目构建与ES的使用
      </a></span> <span class="next"><a href="/Notes/Github/github如何精确搜索项目.html">
        github如何精确搜索项目
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.28dec583.js" defer></script><script src="/assets/js/2.6390456d.js" defer></script><script src="/assets/js/16.da318227.js" defer></script>
  </body>
</html>
