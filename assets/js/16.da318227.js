(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{414:function(s,a,t){"use strict";t.r(a);var n=t(56),e=Object(n.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"logstash之mysql全量及增量同步数据到elasticsearch"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#logstash之mysql全量及增量同步数据到elasticsearch"}},[s._v("#")]),s._v(" logstash之mysql全量及增量同步数据到ElasticSearch")]),s._v(" "),t("h2",{attrs:{id:"前言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),t("p",[s._v("我一般数据都是存在mysql的，但是mysql的全文检索性能，大家也都知道。数据量小还没啥事，一旦数据量上了几百万，几千万，分分钟给你卡死...")]),s._v(" "),t("p",[s._v("所以我都是把需要检索用到的数据，同步到es中。但是怎么同步呢？我之前提到过"),t("code",[s._v("logstash")]),s._v("。有人说，把mysql中的数据导出成csv同步到es，或者就excel直接扔到es中。这种方法我也去实践了一遍，结果经常有一些数据中含有特殊的一些字符，同步失败，而导致很多数据都没有成功同步上去。")]),s._v(" "),t("p",[s._v("那算了，这种方法我们就弃用了！")]),s._v(" "),t("p",[t("code",[s._v("logstash")]),s._v("其实给我们提供了，mysql数据同步到es中。无需我们初始化一个demo，写一大堆代码，同步到es中。")]),s._v(" "),t("p",[s._v("说干就干！")]),s._v(" "),t("h2",{attrs:{id:"准备工作"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#准备工作"}},[s._v("#")]),s._v(" 准备工作")]),s._v(" "),t("p",[s._v("es与logstash的版本保持一致，")]),s._v(" "),t("p",[s._v("下载jdbc-connector的jar包，"),t("code",[s._v("mysql-connector-java.jar")])]),s._v(" "),t("p",[t("em",[s._v("maven仓库下载")]),s._v("：https://mvnrepository.com/artifact/mysql/mysql-connector-java")]),s._v(" "),t("p",[s._v("下载完成后，解压到logstash/lib/jars/中。")]),s._v(" "),t("h3",{attrs:{id:"配置导入脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置导入脚本"}},[s._v("#")]),s._v(" 配置导入脚本")]),s._v(" "),t("p",[s._v("新建配置目录：sync-config，新建"),t("code",[s._v("jdbc.conf")])]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[s._v("input "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    stdin "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    jdbc "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n   \t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mysql 数据库链接")]),s._v("\n        jdbc_connection_string ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "jdbc'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("mysql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//127.0.0.1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("3306/cicada"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("?")]),s._v('characterEncoding=utf8"\n        '),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 用户名和密码")]),s._v("\n        jdbc_user ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "root"\n        jdbc_password ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "root123"\n        '),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 驱动")]),s._v("\n        jdbc_driver_library ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "./lib/jars/mysql'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("connector"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("java"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('5.1.13.jar"\n        '),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 驱动类名")]),s._v("\n        jdbc_driver_class ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "com.mysql.jdbc.Driver"\n        jdbc_paging_enabled ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "true"\n        jdbc_page_size ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "50000"\n        '),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 时区")]),s._v("\n        jdbc_default_timezone ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "Asia/Shanghai"\n        '),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 执行的sql文件路径和名称")]),s._v("\n        statement_filepath ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "./sync'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('config/user_sql.sql"\n        '),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#直接执行sql语句")]),s._v("\n      \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# statement =>"select * from employee"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置监听间隔，各字段含义（由左至右）分、时、天、月、年，全部为*默认含义为每分钟都更新")]),s._v("\n        schedule ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "* * * * '),t("span",{pre:!0,attrs:{class:"token important"}},[s._v('*"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 索引类型")]),s._v("\n        type ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "User"\n        lowercase_column_names ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" false\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否记录最后一次运行内容")]),s._v("\n        record_last_run ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" true\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 是否适用列元素")]),s._v("\n        use_column_value ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" true\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 追踪的元素名，对应保存到es上面的字段名而不是数据库字段名")]),s._v("\n        tracking_column ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "updateTime"\n        '),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 默认为number，如果为日期必须声明为timestamp")]),s._v("\n        tracking_column_type ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "timestamp"\n        '),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置记录的路径")]),s._v("\n        last_run_metadata_path ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "./sync'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('config/user_last_time"\n        clean_run ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" false\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    jdbc "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        jdbc_connection_string ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "jdbc'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("mysql"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//127.0.0.1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("3306/cicada"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("?")]),s._v('characterEncoding=utf8"\n        jdbc_user ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "root"\n        jdbc_password ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "root123"\n        jdbc_driver_library ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "./lib/jars/mysql'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("connector"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("java"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('5.1.13.jar"\n        jdbc_driver_class ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "com.mysql.jdbc.Driver"\n        jdbc_paging_enabled ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "true"\n        jdbc_page_size ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "50000"\n        jdbc_default_timezone ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "Asia/Shanghai"\n        statement_filepath ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "./sync'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('config/log_sql.sql"\n        schedule ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "* * * * '),t("span",{pre:!0,attrs:{class:"token important"}},[s._v('*"')]),s._v("\n        type ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "Log"\n        lowercase_column_names ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" false\n        record_last_run ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" true\n        use_column_value ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" true\n        tracking_column ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "updateTime"\n        tracking_column_type ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "timestamp"\n        last_run_metadata_path ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "./sync'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v('config/log_last_time"\n        clean_run ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" false\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\nfilter "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    json "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        source ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "message"\n        remove_field ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"message"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\noutput "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    if "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("type"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' == "User" '),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        elasticsearch "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            hosts ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1:9200"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 索引名称")]),s._v("\n            index ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "cicada_user_search"\n            '),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# type名称")]),s._v("\n            document_type ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "user_search_index"\n             '),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 文档id，inquiryId为sql文件中查询出的字段名")]),s._v("\n            document_id ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "%'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("id"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v('"\n        '),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    if "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("type"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(' == "Log" '),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        elasticsearch "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            hosts ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"127.0.0.1:9200"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n            index ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "cicada_log_search"\n            document_type ='),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "log_search_index"\n        '),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br"),t("span",{staticClass:"line-number"},[s._v("62")]),t("br"),t("span",{staticClass:"line-number"},[s._v("63")]),t("br"),t("span",{staticClass:"line-number"},[s._v("64")]),t("br"),t("span",{staticClass:"line-number"},[s._v("65")]),t("br"),t("span",{staticClass:"line-number"},[s._v("66")]),t("br"),t("span",{staticClass:"line-number"},[s._v("67")]),t("br"),t("span",{staticClass:"line-number"},[s._v("68")]),t("br"),t("span",{staticClass:"line-number"},[s._v("69")]),t("br"),t("span",{staticClass:"line-number"},[s._v("70")]),t("br"),t("span",{staticClass:"line-number"},[s._v("71")]),t("br"),t("span",{staticClass:"line-number"},[s._v("72")]),t("br"),t("span",{staticClass:"line-number"},[s._v("73")]),t("br"),t("span",{staticClass:"line-number"},[s._v("74")]),t("br"),t("span",{staticClass:"line-number"},[s._v("75")]),t("br"),t("span",{staticClass:"line-number"},[s._v("76")]),t("br"),t("span",{staticClass:"line-number"},[s._v("77")]),t("br"),t("span",{staticClass:"line-number"},[s._v("78")]),t("br"),t("span",{staticClass:"line-number"},[s._v("79")]),t("br"),t("span",{staticClass:"line-number"},[s._v("80")]),t("br"),t("span",{staticClass:"line-number"},[s._v("81")]),t("br"),t("span",{staticClass:"line-number"},[s._v("82")]),t("br"),t("span",{staticClass:"line-number"},[s._v("83")]),t("br"),t("span",{staticClass:"line-number"},[s._v("84")]),t("br")])]),t("h3",{attrs:{id:"sql文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sql文件"}},[s._v("#")]),s._v(" SQL文件")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("user_sql.sql")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v("\n\tid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tuser_name userName"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tuser_phone userPhone"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tcreate_time createTime"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\tupdate_time updateTime\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" c_user\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" update_time "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" :sql_last_value\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("log_sql.sql")]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("SELECT\n\tid,\n\tparam_value paramValue,\n\trequest_ip requestIp,\n\tcreate_time createTime,\n\tupdate_time updateTime\nFROM c_log\nWHERE update_time > :sql_last_value\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"配置参数说明"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置参数说明"}},[s._v("#")]),s._v(" 配置参数说明")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("input参数")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[s._v("statement_filepath：读取SQL语句位置\nschedule ：这里配置每分钟执行一次\ntype ：类型，写入ES的标识\nlowercase_column_names ：字段是否转小写\nrecord_last_run ：记录上次执行时间\nuse_column_value ：使用列的值\ntracking_column ：根据写入ES的updateTime字段区分增量数据\ntracking_column_type ：区分的字段类型\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])])]),s._v(" "),t("li",[t("p",[s._v("output参数")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[s._v("hosts ：ES服务地址\nindex ：Index名称，类比理解数据库名称\ndocument_type ：Type名称，类比理解表名称\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])])])]),s._v(" "),t("h3",{attrs:{id:"启动导入脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#启动导入脚本"}},[s._v("#")]),s._v(" 启动导入脚本")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("logstash -f "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"./sync-config/jdbc.conf"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"其他"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#其他"}},[s._v("#")]),s._v(" 其他")]),s._v(" "),t("h3",{attrs:{id:"logstash7-x同步mysql数据到es报错"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#logstash7-x同步mysql数据到es报错"}},[s._v("#")]),s._v(" logstash7.x同步mysql数据到es报错")]),s._v(" "),t("p",[s._v("logstash能正常启动但是同步数据到es时报错")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("com.mysql.jdbc.Driver not loaded. Are you sure you’ve included the correct jdbc driver in :jdbc_driver_library?\nUnable to find driver class via URLClassLoader in given driver jars: com.mysql.jdbc.Driver and com.mysql.jdbc.Driver\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[t("strong",[s._v("解决办法")]),s._v("：将mysql的驱动jar包拷贝到logstash目录\\logstash-core\\lib\\jars 下")]),s._v(" "),t("p",[s._v("如果这种办法没有解决你的问题，你可以看看这篇帖子，我没试过，因为上面这种方法解决了我的问题。")]),s._v(" "),t("p",[s._v("https://www.jianshu.com/p/0e893f29ee05")]),s._v(" "),t("p",[t("em",[s._v("LogStash 7.x com.mysql.cj.jdbc.Driver not loaded")])]),s._v(" "),t("h3",{attrs:{id:"mysql资源下载"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mysql资源下载"}},[s._v("#")]),s._v(" MYSQL资源下载")]),s._v(" "),t("p",[s._v("https://downloads.mysql.com/archives/")]),s._v(" "),t("h3",{attrs:{id:"logstash-配置定时"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#logstash-配置定时"}},[s._v("#")]),s._v(" Logstash 配置定时")]),s._v(" "),t("div",{staticClass:"language-yml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置监听时段 个字段含义(从左到右)，分,时,天,月,年, ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 全部默认为*号默认为每分钟更新")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#每分钟执行一次")]),s._v("\nschedule ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "* * * * * "\n'),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每间隔一分钟执行一次")]),s._v("\nschedule ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v(' "'),t("span",{pre:!0,attrs:{class:"token important"}},[s._v("*/1")]),s._v(" * * * "),t("span",{pre:!0,attrs:{class:"token important"}},[s._v('*"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#每小时执行一次")]),s._v("\nschedule ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v('"* '),t("span",{pre:!0,attrs:{class:"token important"}},[s._v("*/1")]),s._v(" * * "),t("span",{pre:!0,attrs:{class:"token important"}},[s._v('*"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#某个时间点执行")]),s._v("\nschedule ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v('"* 1 * * '),t("span",{pre:!0,attrs:{class:"token important"}},[s._v('*"')]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每天上午1点执行")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#多个时间点执行")]),s._v("\nschedule ="),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")]),s._v('"* 1'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("5 * * "),t("span",{pre:!0,attrs:{class:"token important"}},[s._v('*"')]),s._v("    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 每天上午1,3,5点执行")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("h3",{attrs:{id:"es-mysql-logstash-软删除的实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#es-mysql-logstash-软删除的实现"}},[s._v("#")]),s._v(" es-mysql-logstash 软删除的实现")]),s._v(" "),t("p",[s._v("如果一个文档从 MySQL 中删除，该操作并不会同步到 ElasticSearch 中。列举几个我们可以考虑的方案。")]),s._v(" "),t("p",[s._v("MySQL 中的记录可通过包含 is_deleted 字段以表明该条记录是否有效。一旦发生更新，is_deleted 也会同步更新到 ElasticSearch 中。如果通过这种方式，在执行 MySQL 或 ElasticSearch 查询时，重写查询语句来过滤掉 is_deleted 为 true 的记录。同时，可以通过一些后台进程将 MySQL 和 ElasticSearch 中的这些文档删除。")]),s._v(" "),t("p",[s._v("另一个可选方案是，应用系统负责 MySQL 和 ElasticSearch 中数据的删除，即应用系统在删除 MySQL 中数据，同时负责也删除 ElasticSearch 中相应的文档。这个就会到程序层面的开发工作。")]),s._v(" "),t("p",[s._v("再谈一种方案，脱离 logstash 来谈这个问题。")]),s._v(" "),t("p",[s._v("可以通过 mysql 的 binlog 实现数据库中的得事件(增加、更新、删除)同步，任何事件实时同步到 Elasticsearch。这个相对较复杂了。但好在已经有了开源组件可以用，即阿里的 canal。不过，我个人认为，项目不大，且实时性要求不高，还是用 logstash 比较简单省心。canal 在单表时，还比较简单，如果涉及多表，也不方便，根据需求会有不定量的的开发工作。")]),s._v(" "),t("p",[s._v("最后，要依据场景选择合适的方案。把它们进行适时地结合，实时性要求高，用 canal 实现，一般场景，logstash 即可，即使是有题主提的删除，也不建议使用 canal，而是用前面提到的几个思路。有能力的话，其实可以针对这两种方案设计一个数据同步框架，以后只要加个配置即可完成。")]),s._v(" "),t("p",[t("strong",[s._v("这里的方案，是我在网上看到的，最近不着急实现这个功能，有空了再实现一下。")])]),s._v(" "),t("h3",{attrs:{id:"联表的sql文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#联表的sql文件"}},[s._v("#")]),s._v(" 联表的sql文件")]),s._v(" "),t("div",{staticClass:"language-mysql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("SELECT `a`.`id`,`a`.`catid`,`a`.`catids`,`a`.`title`,`f`.`name`, `a`.`status`,a.updated_at FROM `c_product` `a` LEFT JOIN `c_company` `f` ON f.id = a.cid WHERE a.updated_at > :sql_last_value order by a.updated_at\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);